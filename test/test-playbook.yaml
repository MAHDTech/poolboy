---
- hosts: localhost
  gather_facts: false
  vars:
    oc_cmd: oc
    operator_domain: poolboy.gpte.redhat.com
    operator_namespace: poolboy
    operator_service_name: poolboy
    operator_test_namespace: poolboy-test
    build: true
    local_test: false
  tasks:
  - when: build
    block:
    - name: Start operator build
      command: >-
        {{ oc_cmd }} start-build {{ operator_service_name }}
        -n {{ operator_namespace | quote }}
        --from-dir {{ playbook_dir }}/..

    - name: Get BuildConfig
      k8s_facts:
        api_version: build.openshift.io/v1
        kind: BuildConfig
        name: "{{ operator_service_name }}"
        namespace: "{{ operator_namespace }}"
      register: operator_buildconfig

    - name: Wait for operator build
      k8s_facts:
        api_version: build.openshift.io/v1
        kind: Build
        name: "{{ operator_service_name }}-{{ operator_buildconfig.resources[0].status.lastVersion }}"
        namespace: "{{ operator_namespace }}"
      register: operator_build
      until: operator_build.resources[0].status.phase in ['Complete', 'Failed']
      retries: 30
      delay: 10

    - name: Assert that exactly one deploy action for test-1 was found
      assert:
        that:
        - operator_build.resources[0].status.phase == 'Complete'
        fail_msg: Operator build did not complete
        success_msg: Operator build complete

  - name: Scale down operator
    command: oc scale deployment {{ operator_service_name }} -n {{ operator_namespace | quote }} --replicas=0

  - name: Wait for operator scale down
    k8s_facts:
      api_version: v1
      kind: Pod
      namespace: "{{ operator_namespace }}"
      label_selectors:
      - name={{ operator_service_name }}
    register: get_operator_pod
    until: get_operator_pod.resources | length == 0
    retries: 30
    delay: 5

  - name: Get test resource claims
    k8s_facts:
      api_version: "{{ operator_domain }}/v1"
      kind: ResourceClaim
      namespace: "{{ operator_test_namespace }}"
    register: test_claims

  - name: Remove finalizer from test resource claims
    command: >-
      {{ oc_cmd }} patch resourceclaim.{{ operator_domain }} {{ claim.metadata.name }}
      -n {{ operator_test_namespace }}
      --type=merge -p {{ patch | to_json | quote}}
    loop: "{{ test_claims.resources }}"
    loop_control:
      label: "{{ claim.metadata.name }}"
      loop_var: claim
    vars:
      patch:
        metadata:
          finalizers: []

  - name: Remove test resource claims
    k8s:
      state: absent
      api_version: "{{ operator_domain }}/v1"
      kind: ResourceClaim
      name: "{{ claim.metadata.name }}"
      namespace: "{{ operator_test_namespace }}"
    loop: "{{ test_claims.resources }}"
    loop_control:
      label: "{{ claim.metadata.name }}"
      loop_var: claim

  - name: Get test resource handles
    k8s_facts:
      api_version: "{{ operator_domain }}/v1"
      kind: ResourceHandle
      namespace: "{{ operator_namespace }}"
      label_selectors:
      - "{{ operator_domain }}/resource-provider-name=test"
    register: test_handles

  - name: Remove finalizer from test resource handles
    command: >-
      {{ oc_cmd }} patch resourcehandle.{{ operator_domain }} {{ handle.metadata.name }}
      -n {{ operator_namespace }}
      --type=merge -p {{ patch | to_json | quote}}
    loop: "{{ test_handles.resources }}"
    loop_control:
      label: "{{ handle.metadata.name }}"
      loop_var: handle
    vars:
      patch:
        metadata:
          finalizers: []

  - name: Remove test resource handles
    k8s:
      state: absent
      api_version: "{{ operator_domain }}/v1"
      kind: ResourceHandle
      name: "{{ handle.metadata.name }}"
      namespace: "{{ operator_namespace }}"
    loop: "{{ test_handles.resources }}"
    loop_control:
      label: "{{ handle.metadata.name }}"
      loop_var: handle

  - name: Get resource claim tests
    k8s_facts:
      api_version: "{{ operator_domain }}/v1"
      kind: ResourceClaimTest
      namespace: "{{ operator_test_namespace }}"
    register: resource_claim_tests

  - name: Remove resource claim tests
    k8s:
      state: absent
      api_version: "{{ operator_domain }}/v1"
      kind: ResourceClaimTest
      name: "{{ resource_claim_test.metadata.name }}"
      namespace: "{{ operator_test_namespace }}"
    loop: "{{ resource_claim_tests.resources }}"
    loop_control:
      label: "{{ resource_claim_test.metadata.name }}"
      loop_var: resource_claim_test

  - name: Remove test ResourceProvider
    k8s:
      state: absent
      api_version: "{{ operator_domain }}/v1"
      kind: ResourceProvider
      name: test
      namespace: "{{ operator_namespace }}"

  - name: Remove test-new ResourceProvider
    k8s:
      state: absent
      api_version: "{{ operator_domain }}/v1"
      kind: ResourceProvider
      name: test-new
      namespace: "{{ operator_namespace }}"

  - debug:
      msg: "{{ lookup('template', 'test-resource-provider.yaml.j2') }}"

  - name: Create test ResourceProvider
    k8s:
      state: present
      definition: "{{ lookup('template', 'test-resource-provider.yaml.j2') | from_yaml }}"

  - when: not local_test | bool
    block:
    - name: Scale up operator
      command: oc scale deployment {{ operator_service_name }} -n {{ operator_namespace | quote }} --replicas=1

    - name: Pause for operator start-up
      pause:
        seconds: 35

  - name: Create ResourceClaim test-1
    k8s:
      state: present
      definition: "{{ resource_definition | from_yaml }}"
    vars:
      resource_definition: |
        apiVersion: {{ operator_domain }}/v1
        kind: ResourceClaim
        metadata:
          name: test-1
          namespace: {{ operator_test_namespace }}
        spec:
          template:
            apiVersion: {{ operator_domain }}/v1
            kind: ResourceClaimTest
            metadata:
              annotations:
                {{ operator_domain }}/resource-provider-name: test
                {{ operator_domain }}/resource-provider-namespace: {{ operator_namespace }}
            spec:
              governor: test
              parameters:
                name: test-1
                number: 23

  - name: Pause for resource generation
    pause:
      seconds: 10

  - name: Get resource handle for claim test-1
    k8s_facts:
      api_version: "{{ operator_domain }}/v1"
      kind: ResourceHandle
      namespace: "{{ operator_namespace }}"
      label_selectors:
      - "{{ operator_domain }}/resource-claim-name=test-1"
      - "{{ operator_domain }}/resource-claim-namespace={{ operator_test_namespace }}"
    register: resource_handle_for_test_1

  - name: Assert that exactly one handle for test-1 was found
    assert:
      that:
      - resource_handle_for_test_1.resources | length == 1
      fail_msg: One test-1 resource handle not found
      success_msg: One test-1 resource handle found

  - name: Check resource handle for test-1
    assert:
      that:
      - handle.metadata.finalizers[0] == operator_domain
      - handle.metadata.generateName == 'guid-'
      - handle.metadata.labels['{{ operator_domain }}/resource-provider-name'] == 'test'
      - handle.metadata.labels['{{ operator_domain }}/resource-provider-namespace'] == operator_namespace
      - handle.spec.resourceClaim.name == 'test-1'
      - handle.spec.resourceClaim.namespace == operator_test_namespace
      - handle.spec.resourceProvider.name == 'test'
      - handle.spec.resourceProvider.namespace == operator_namespace
      - handle.spec.template.kind == 'ResourceClaimTest'
      - handle.spec.template.spec.parameters.name == 'test-1'
      - handle.spec.template.spec.parameters.number == 23
      fail_msg: test-1 handle not found as expected
      success_msg: test-1 handle found as expected
    vars:
      handle: "{{ resource_handle_for_test_1.resources[0] }}"

  - name: Get resource from handle for test-1
    k8s_facts:
      api_version: "{{ resource_ref.apiVersion }}"
      kind: "{{ resource_ref.kind }}"
      name: "{{ resource_ref.name }}"
      namespace: "{{ resource_ref.namespace | default('') }}"
    vars:
      resource_ref: "{{ resource_handle_for_test_1.resources[0].spec.resource }}"
    register: resource_for_test_1

  - name: Check resource for test-1
    assert:
      that:
      - resource.kind == 'ResourceClaimTest'
      - resource.metadata.annotations['{{ operator_domain }}/resource-claim-name'] == 'test-1'
      - resource.metadata.annotations['{{ operator_domain }}/resource-claim-namespace'] == operator_test_namespace
      - resource.metadata.annotations['{{ operator_domain }}/resource-handle-name'] == handle.metadata.name
      - resource.metadata.annotations['{{ operator_domain }}/resource-handle-namespace'] == handle.metadata.namespace
      - resource.metadata.annotations['{{ operator_domain }}/resource-handle-uid'] == handle.metadata.uid
      - resource.metadata.annotations['{{ operator_domain }}/resource-handle-version'] == handle.metadata.resourceVersion
      - resource.metadata.annotations['{{ operator_domain }}/resource-provider-name'] == 'test'
      - resource.metadata.annotations['{{ operator_domain }}/resource-provider-namespace'] == operator_namespace
      fail_msg: test-1 resource not found as expected
      success_msg: test-1 resource looks good
    vars:
      handle: "{{ resource_handle_for_test_1.resources[0] }}"
      resource: "{{ resource_for_test_1.resources[0] }}"

  - name: Get resource claim test-1
    k8s_facts:
      api_version: "{{ operator_domain }}/v1"
      kind: ResourceClaim
      name: test-1
      namespace: "{{ operator_test_namespace }}"
    register: test_1_claim

  - name: Check claim test-1
    assert:
      that:
      - claim.status.resource.kind == 'ResourceClaimTest'
      - claim.status.resource.metadata.namespace == operator_test_namespace
      - claim.status.resource.spec.parameters.name == 'test-1'
      - claim.status.resource.spec.parameters.number == 23
      fail_msg: test-1 resource not found as expected
      success_msg: test-1 resource looks good
    vars:
      claim: "{{ test_1_claim.resources[0] }}"

  - name: Update ResourceClaim test-1
    k8s:
      state: present
      definition: "{{ resource_definition }}"
    vars:
      resource_definition: |
        apiVersion: {{ operator_domain }}/v1
        kind: ResourceClaim
        metadata:
          name: test-1
          namespace: {{ operator_test_namespace }}
        spec:
          template:
            apiVersion: {{ operator_domain }}/v1
            kind: ResourceClaimTest
            metadata:
              annotations:
                {{ operator_domain }}/resource-provider-name: test
                {{ operator_domain }}/resource-provider-namespace: {{ operator_namespace }}
            spec:
              desiredState: started
              governor: test
              parameters:
                name: test-1
                foo: bar
                number: 42

  - name: Pause for claim resource status update
    pause:
      seconds: 5

  - name: Get resource handle for claim test-1
    k8s_facts:
      api_version: "{{ operator_domain }}/v1"
      kind: ResourceHandle
      namespace: "{{ operator_namespace }}"
      label_selectors:
      - "{{ operator_domain }}/resource-claim-name=test-1"
      - "{{ operator_domain }}/resource-claim-namespace={{ operator_test_namespace }}"
    register: resource_handle_for_test_1

  - name: Check update of resource handle for test-1
    assert:
      that:
      - handle.metadata.finalizers[0] == operator_domain
      - handle.metadata.generateName == 'guid-'
      - handle.metadata.labels['{{ operator_domain }}/resource-provider-name'] == 'test'
      - handle.spec.resourceClaim.name == 'test-1'
      - handle.spec.resourceClaim.namespace == operator_test_namespace
      - handle.spec.resourceProvider.name == 'test'
      - handle.spec.resourceProvider.namespace == operator_namespace
      - handle.spec.template.kind == 'ResourceClaimTest'
      - handle.spec.template.spec.parameters.name == 'test-1'
      - handle.spec.template.spec.parameters.number == 42
      fail_msg: test-1 handle not found as expected
      success_msg: test-1 handle found as expected
    vars:
      handle: "{{ resource_handle_for_test_1.resources[0] }}"

  - name: Get resource claim test-1
    k8s_facts:
      api_version: "{{ operator_domain }}/v1"
      kind: ResourceClaim
      name: test-1
      namespace: "{{ operator_test_namespace }}"
    register: test_1_claim

  - name: Check claim test-1 update
    assert:
      that:
      - claim.status.resource.kind == 'ResourceClaimTest'
      - claim.status.resource.metadata.namespace == operator_test_namespace
      - claim.status.resource.spec.parameters.name == 'test-1'
      # Check changes to parameters are rejected on the resource
      - claim.status.resource.spec.parameters.number == 23
      # Change to desiredState should go through
      - claim.status.resource.spec.desiredState == 'started'
      fail_msg: test-1 resource not found as expected
      success_msg: test-1 resource looks good
    vars:
      claim: "{{ test_1_claim.resources[0] }}"

  - name: Delete resource claim test-1
    k8s:
      state: absent
      api_version: "{{ operator_domain }}/v1"
      kind: ResourceClaim
      name: test-1
      namespace: "{{ operator_test_namespace }}"

  - name: Pause for delete cascade
    pause:
      seconds: 2

  - name: Confirm resource deletion for test-1
    k8s_facts:
      api_version: "{{ resource_ref.apiVersion }}"
      kind: "{{ resource_ref.kind }}"
      name: "{{ resource_ref.name }}"
      namespace: "{{ resource_ref.namespace | default('') }}"
    vars:
      resource_ref: "{{ resource_handle_for_test_1.resources[0].spec.resource }}"
    register: resource_for_test_1
    failed_when: resource_for_test_1.resources
